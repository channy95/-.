<!DOCTYPE html>
<!-- saved from url=(0096)https://page.genspark.site/page/toolu_01Ht3TwPuiQrpkhDArXsAzv4/us_market_analyzer_optimized.html -->
<html lang="ko"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미국 시장 지표 분석기</title>
    <link href="./index_files/tailwind.min.css" rel="stylesheet">
    <!-- 필요한 스크립트만 비동기적으로 로드 -->
    <script src="./index_files/chart.min.js" defer=""></script>
    <script src="./index_files/chartjs-chart-matrix.min.js" defer=""></script>
    <script src="./index_files/luxon.min.js" defer=""></script>
    <script src="./index_files/chartjs-adapter-luxon.min.js" defer=""></script>
    <!-- FontAwesome 아이콘 대신 jsdelivr에서 제공하는 더 가벼운 Feather 아이콘 사용 -->
    <link href="./index_files/feather.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 400px;
            width: 100%;
            margin-bottom: 30px;
            display: none; /* 필요할 때만 표시 */
        }
        .matrix-container {
            position: relative;
            margin: auto;
            height: 500px;
            width: 100%;
            max-width: 500px;
            margin-bottom: 30px;
            display: none; /* 필요할 때만 표시 */
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }
        .loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .shadow-custom {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            width: 240px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        #autocompleteResults {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 0.375rem 0.375rem;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #f7fafc;
        }
        .selected-stock {
            display: flex;
            align-items: center;
            background-color: #e6f7ff;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .remove-stock {
            margin-left: 0.5rem;
            color: #f56565;
            cursor: pointer;
        }
        
        /* 성능 최적화를 위한 추가 스타일 */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-right: 0.5rem;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* 스켈레톤 로딩 효과 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            height: 20px;
            margin-bottom: 8px;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* 반응형 UI 최적화 */
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            .matrix-container {
                height: 400px;
                width: 100%;
            }
            h1.text-3xl {
                font-size: 1.5rem;
            }
        }
    </style>
<style type="text/css">.resize-observer[data-v-8859cc6c]{position:absolute;top:0;left:0;z-index:-1;width:100%;height:100%;border:none;background-color:transparent;pointer-events:none;display:block;overflow:hidden;opacity:0}.resize-observer[data-v-8859cc6c] object{display:block;position:absolute;top:0;left:0;height:100%;width:100%;overflow:hidden;pointer-events:none;z-index:-1}</style><style type="text/css">x-vue-echarts{display:flex;flex-direction:column;width:100%;height:100%;min-width:0}
.vue-echarts-inner{flex-grow:1;min-width:0;width:auto!important;height:auto!important}
</style></head>
<body class="p-4" ap-style=""><audio class="audio-for-speech" src=""></audio><div class="translate-tooltip-mtz blue sm-root translate hidden_translate">
                    <div class="header-wrapper">
                        <div class="header-controls">
                            <span class="sound-translate"></span>
                            <span class="copy blue"></span>
                            <span class="settings-translator"></span>
                        </div>
                        <div class="header-title">translator</div>
                        <div class="translate-icons">
                            <img class="from" src="https://page.genspark.site/page/toolu_01Ht3TwPuiQrpkhDArXsAzv4/us_market_analyzer_optimized.html">
                            <img class="translate-arrow" src="chrome-extension://bebmphofpgkhclocdbgomhnjcpelbenh/images/right-arrow.png">
                            <div class="translate_to_dropdown">
                                <button class="dropbtn dropdown-toggle" type="button" id="dropdownMenuButton1" aria-expanded="false"></button>
                                <ul class="dropdown-content-wrapper languageSelector blue">
                                    <li><a class="dropdown-item" data-lang="af">Afrikaans</a></li>
                                    <li><a class="dropdown-item" data-lang="sq">Albanian - shqipe</a></li>
                                    <li><a class="dropdown-item" data-lang="ar">Arabic - ‎‫العربية‬‎</a></li>
                                    <li><a class="dropdown-item" data-lang="hy">Armenian - Հայերէն</a></li>
                                    <li><a class="dropdown-item" data-lang="az">Azerbaijani - azərbaycanca</a></li>
                                    <li><a class="dropdown-item" data-lang="eu">Basque - euskara</a></li>
                                    <li><a class="dropdown-item" data-lang="be">Belarusian - беларуская</a></li>
                                    <li><a class="dropdown-item" data-lang="bn">Bengali - বাংলা</a></li>
                                    <li><a class="dropdown-item" data-lang="bg">Bulgarian - български</a></li>
                                    <li><a class="dropdown-item" data-lang="ca">Catalan - català</a></li>
                                    <li><a class="dropdown-item" data-lang="zh-CN">Chinese - 中文（简体中文）</a></li>
                                    <li><a class="dropdown-item" data-lang="zh-TW">Chinese - 中文 (繁體中文)</a></li>
                                    <li><a class="dropdown-item" data-lang="hr">Croatian - hrvatski</a></li>
                                    <li><a class="dropdown-item" data-lang="cs">Czech - čeština</a></li>
                                    <li><a class="dropdown-item" data-lang="da">Danish - dansk</a></li>
                                    <li><a class="dropdown-item" data-lang="nl">Dutch - Nederlands</a></li>
                                    <li><a class="dropdown-item" data-lang="en">English</a></li>
                                    <li><a class="dropdown-item" data-lang="eo">Esperanto - esperanto</a></li>
                                    <li><a class="dropdown-item" data-lang="et">Estonian - eesti</a></li>
                                    <li><a class="dropdown-item" data-lang="tl">Filipino</a></li>
                                    <li><a class="dropdown-item" data-lang="fi">Finnish - suomi</a></li>
                                    <li><a class="dropdown-item" data-lang="fr">French - français</a></li>
                                    <li><a class="dropdown-item" data-lang="gl">Galician - galego</a></li>
                                    <li><a class="dropdown-item" data-lang="ka">Georgian - ქართული</a></li>
                                    <li><a class="dropdown-item" data-lang="de">German - Deutsch</a></li>
                                    <li><a class="dropdown-item" data-lang="el">Greek - Ελληνικά</a></li>
                                    <li><a class="dropdown-item" data-lang="gu">Gujarati - ગુજરાતી</a></li>
                                    <li><a class="dropdown-item" data-lang="ht">Haitian Creole - kreyòl ayisyen</a></li>
                                    <li><a class="dropdown-item" data-lang="iw">Hebrew - ‎‫עברית‬‎</a></li>
                                    <li><a class="dropdown-item" data-lang="hi">Hindi - हिन्दी</a></li>
                                    <li><a class="dropdown-item" data-lang="hu">Hungarian - magyar</a></li>
                                    <li><a class="dropdown-item" data-lang="is">Icelandic - íslenska</a></li>
                                    <li><a class="dropdown-item" data-lang="id">Indonesian - Bahasa Indonesia</a></li>
                                    <li><a class="dropdown-item" data-lang="ga">Irish - Gaeilge</a></li>
                                    <li><a class="dropdown-item" data-lang="it">Italian - italiano</a></li>
                                    <li><a class="dropdown-item" data-lang="ja">Japanese - 日本語</a></li>
                                    <li><a class="dropdown-item" data-lang="kn">Kannada - ಕನ್ನಡ</a></li>
                                    <li><a class="dropdown-item" data-lang="ko">Korean - 한국어</a></li>
                                    <li><a class="dropdown-item" data-lang="la">Latin - Lingua Latina</a></li>
                                    <li><a class="dropdown-item" data-lang="lv">Latvian - latviešu</a></li>
                                    <li><a class="dropdown-item" data-lang="lt">Lithuanian - lietuvių</a></li>
                                    <li><a class="dropdown-item" data-lang="mk">Macedonian - македонски</a></li>
                                    <li><a class="dropdown-item" data-lang="ms">Malay - Bahasa Melayu</a></li>
                                    <li><a class="dropdown-item" data-lang="mt">Maltese - Malti</a></li>
                                    <li><a class="dropdown-item" data-lang="no">Norwegian - norsk</a></li>
                                    <li><a class="dropdown-item" data-lang="fa">Persian - ‎‫فارسی‬‎</a></li>
                                    <li><a class="dropdown-item" data-lang="pl">Polish - polski</a></li>
                                    <li><a class="dropdown-item" data-lang="pt">Portuguese - português</a></li>
                                    <li><a class="dropdown-item" data-lang="ro">Romanian - română</a></li>
                                    <li><a class="dropdown-item" data-lang="ru">Russian - русский</a></li>
                                    <li><a class="dropdown-item" data-lang="sr">Serbian - Српски</a></li>
                                    <li><a class="dropdown-item" data-lang="sk">Slovak - slovenčina</a></li>
                                    <li><a class="dropdown-item" data-lang="sl">Slovenian - slovenščina</a></li>
                                    <li><a class="dropdown-item" data-lang="es">Spanish - español</a></li>
                                    <li><a class="dropdown-item" data-lang="sw">Swahili - Kiswahili</a></li>
                                    <li><a class="dropdown-item" data-lang="sv">Swedish - svenska</a></li>
                                    <li><a class="dropdown-item" data-lang="ta">Tamil - தமிழ்</a></li>
                                    <li><a class="dropdown-item" data-lang="te">Telugu - తెలుగు</a></li>
                                    <li><a class="dropdown-item" data-lang="th">Thai - ไทย</a></li>
                                    <li><a class="dropdown-item" data-lang="tr">Turkish - Türkçe</a></li>
                                    <li><a class="dropdown-item" data-lang="uk">Ukrainian - українська</a></li>
                                    <li><a class="dropdown-item" data-lang="ur">Urdu - ‎‫اردو‬‎</a></li>
                                    <li><a class="dropdown-item" data-lang="vi">Vietnamese - Tiếng Việt</a></li>
                                    <li><a class="dropdown-item" data-lang="cy">Welsh - Cymraeg</a></li>
                                    <li><a class="dropdown-item" data-lang="yi">Yiddish - יידיש</a></li>
                            </ul>
                          </div>
                        </div>
                    </div>
                    <div class="translated-text">
                        <div id="translator-words" class="words"></div>
                        <div class="sentences blue"></div>
                    </div>
                    <div class="trans_controls">
                        <div class="trans_controls__control-wrapper double_click">
                            <span class="trans_controls__toggle dbl-click active" data-store="double_click">
                                <div class="trans_controls__inner-circle"></div>
                            </span>
                            <span class="trans_controls__description">
                            Double-click
                            </span>
                        </div>
                        <div class="trans_controls__control-wrapper selection">
                            <span class="trans_controls__toggle icon-trans active" data-store="icon_trans">
                                <div class="trans_controls__inner-circle"></div>
                            </span>
                            <span class="trans_controls__description">
                            Select to translate
                            </span>
                        </div>
                    </div>
                </div><span class="translate-button-mtz hidden_translate blue"></span>
    <div class="loading" id="loadingIndicator" style="display: none;">
        <div class="loader"></div>
        <p class="text-lg" id="loadingText">데이터를 불러오는 중입니다...</p>
    </div>

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-800">미국 시장 지표 분석기</h1>
        <div class="text-center mb-4 text-gray-600">
            <p>미국 주식 시장과 경제 지표 간의 상관관계를 분석할 수 있는 도구입니다.</p>
            <p class="mt-2 text-sm">Yahoo Finance API를 통해 실시간 데이터를 가져옵니다.</p>
        </div>

        <!-- 주식 검색 섹션 -->
        <div class="bg-white rounded-lg shadow-custom p-5 mb-5">
            <h2 class="text-xl font-semibold mb-3">NYSE 상장 주식 검색</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        기업명 또는 티커 심볼로 검색
                        <span class="tooltip-container ml-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="tooltip-text">NYSE에 상장된 기업을 검색하여 분석에 추가할 수 있습니다. 예: Apple, AAPL, Microsoft, MSFT 등</span>
                        </span>
                    </label>
                    <div class="relative">
                        <input type="text" id="stockSearch" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="예: Apple, AAPL, Microsoft, MSFT">
                        <div id="autocompleteResults" class="hidden"></div>
                    </div>
                    <button id="searchButton" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        검색
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">선택된 개별 주식</label>
                    <div id="selectedStocks" class="min-h-[100px] p-2 border border-gray-300 rounded-md bg-gray-50">
                        <p id="noStocksMessage" class="text-gray-500 text-sm">아직 선택된 주식이 없습니다. 왼쪽에서 주식을 검색하여 추가해주세요.</p>
                    </div>
                </div>
            </div>
            
            <div id="stockInfo" class="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50 hidden">
                <!-- 주식 정보가 여기에 표시됩니다 -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-custom p-5 mb-5">
            <h2 class="text-xl font-semibold mb-3">분석 설정</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">분석 기간 선택</label>
                    <div class="flex space-x-4">
                        <select id="period" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1m">1개월</option>
                            <option value="3m">3개월</option>
                            <option value="6m">6개월</option>
                            <option value="1y" selected="">1년</option>
                            <option value="2y">2년</option>
                            <option value="5y">5년</option>
                            <option value="10y">10년</option>
                            <option value="max">최대</option>
                        </select>
                    </div>

                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">시작 날짜 - 종료 날짜 직접 설정</label>
                        <div class="flex space-x-2">
                            <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        분석 지표 선택
                        <span class="tooltip-container ml-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="tooltip-text">최소 2개, 최대 8개의 지표를 선택하세요. 다양한 지표를 분석하여 시장 간의 관계를 파악할 수 있습니다.</span>
                        </span>
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="sp500" value="^GSPC" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500" checked="">
                            <label for="sp500" class="ml-2 text-sm text-gray-700">S&amp;P 500</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="nasdaq" value="^IXIC" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500" checked="">
                            <label for="nasdaq" class="ml-2 text-sm text-gray-700">나스닥</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dowjones" value="^DJI" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="dowjones" class="ml-2 text-sm text-gray-700">다우존스</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="russell" value="^RUT" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="russell" class="ml-2 text-sm text-gray-700">러셀 2000</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="treasury10y" value="^TNX" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500" checked="">
                            <label for="treasury10y" class="ml-2 text-sm text-gray-700">미국 10년물 국채</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="treasury2y" value="^IRX" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="treasury2y" class="ml-2 text-sm text-gray-700">미국 2년물 국채</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="gold" value="GC=F" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="gold" class="ml-2 text-sm text-gray-700">금</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="oil" value="CL=F" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="oil" class="ml-2 text-sm text-gray-700">WTI 원유</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="vix" value="^VIX" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="vix" class="ml-2 text-sm text-gray-700">VIX 변동성 지수</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dollar" value="DX-Y.NYB" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="dollar" class="ml-2 text-sm text-gray-700">달러 인덱스</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="bitcoin" value="BTC-USD" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="bitcoin" class="ml-2 text-sm text-gray-700">비트코인</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="realestate" value="IYR" class="indicator-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="realestate" class="ml-2 text-sm text-gray-700">부동산 ETF</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-center">
                <button id="analyzeButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md transition duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    분석 시작
                </button>
            </div>
        </div>

        <div id="resultsSection" style="display: none;">
            <!-- 탭 네비게이션 -->
            <div class="bg-white rounded-lg shadow-custom p-5 mb-5">
                <div class="mb-4 border-b">
                    <ul class="flex flex-wrap -mb-px" id="resultTabs">
                        <li class="mr-2">
                            <button class="tab-button active" data-tab="priceTab">가격 추이</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button" data-tab="patternTab">패턴 분석</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button" data-tab="correlationTab">상관관계</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button" data-tab="returnsTab">변화율 분석</button>
                        </li>
                        <li class="mr-2">
                            <button class="tab-button" data-tab="scatterTab">산점도</button>
                        </li>
                        <li>
                            <button class="tab-button" data-tab="summaryTab">요약</button>
                        </li>
                    </ul>
                </div>
                
                <!-- 탭 콘텐츠 영역 -->
                <div id="tabContents">
                    <!-- 가격 추이 탭 -->
                    <div id="priceTab" class="tab-content active">
                        <h2 class="text-xl font-semibold mb-3">가격 추이 분석</h2>
                        <div class="mb-4">
                            <div class="flex space-x-4 mb-4">
                                <button id="rawPriceBtn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm">실제 가격</button>
                                <button id="normalizedPriceBtn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm">정규화 가격</button>
                            </div>
                            <div class="chart-container" style="display: block;">
                                <canvas id="priceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 패턴 분석 탭 -->
                    <div id="patternTab" class="tab-content">
                        <h2 class="text-xl font-semibold mb-3">주가 패턴 분석</h2>
                        <div class="mb-4">
                            <p class="text-gray-700 mb-3">이동평균선을 통한 주가 트렌드 분석</p>
                            <div class="flex space-x-4 mb-4">
                                <select id="patternStock" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- 종목 옵션이 여기에 동적으로 채워집니다 -->
                                </select>
                                <button id="showPatternBtn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm">패턴 분석</button>
                            </div>
                            <div class="chart-container" style="display: block;">
                                <canvas id="patternChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 상관관계 탭 -->
                    <div id="correlationTab" class="tab-content">
                        <h2 class="text-xl font-semibold mb-3">상관관계 분석</h2>
                        <div class="md:flex flex-wrap">
                            <div class="md:w-full lg:w-1/2 mb-5">
                                <div class="matrix-container mx-auto" style="display: block;">
                                    <canvas id="correlationMatrix"></canvas>
                                </div>
                            </div>
                            <div class="md:w-full lg:w-1/2 pl-0 lg:pl-5">
                                <h3 class="text-lg font-medium mb-2">상관관계 해석</h3>
                                <p class="text-gray-700 mb-4">
                                    상관계수는 -1에서 1 사이의 값으로, 두 지표 간의 관계를 나타냅니다:
                                </p>
                                <ul class="list-disc ml-6 text-gray-700 mb-4">
                                    <li class="mb-2"><span class="text-red-600 font-medium">강한 양의 상관관계(0.7~1.0)</span>: 한 지표가 상승할 때 다른 지표도 강하게 상승</li>
                                    <li class="mb-2"><span class="text-orange-500 font-medium">중간 양의 상관관계(0.3~0.7)</span>: 한 지표가 상승할 때 다른 지표도 어느 정도 상승</li>
                                    <li class="mb-2"><span class="text-gray-500 font-medium">약한 상관관계(-0.3~0.3)</span>: 두 지표 간 관계가 약함</li>
                                    <li class="mb-2"><span class="text-blue-500 font-medium">중간 음의 상관관계(-0.7~-0.3)</span>: 한 지표가 상승할 때 다른 지표는 어느 정도 하락</li>
                                    <li><span class="text-purple-600 font-medium">강한 음의 상관관계(-1.0~-0.7)</span>: 한 지표가 상승할 때 다른 지표는 강하게 하락</li>
                                </ul>
                                <p class="text-gray-700">
                                    상관관계는 인과관계를 의미하지 않습니다. 두 지표가 높은 상관관계를 보이더라도 서로 직접적인 영향을 주는 것은 아닐 수 있습니다.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 변화율 분석 탭 -->
                    <div id="returnsTab" class="tab-content">
                        <h2 class="text-xl font-semibold mb-3">일별 변화율 분석</h2>
                        <div class="chart-container" style="display: block;">
                            <canvas id="returnsChart"></canvas>
                        </div>
                        <div class="chart-container mt-8" style="display: block;">
                            <canvas id="returnsDistributionChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 산점도 탭 -->
                    <div id="scatterTab" class="tab-content">
                        <h2 class="text-xl font-semibold mb-3">산점도 분석</h2>
                        <div class="mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="xAxisSelect" class="block text-sm font-medium text-gray-700 mb-2">X축 지표</label>
                                    <select id="xAxisSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </select>
                                </div>
                                <div>
                                    <label for="yAxisSelect" class="block text-sm font-medium text-gray-700 mb-2">Y축 지표</label>
                                    <select id="yAxisSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container" style="display: block;">
                            <canvas id="scatterChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 요약 탭 -->
                    <div id="summaryTab" class="tab-content">
                        <h2 class="text-xl font-semibold mb-3">분석 결과 요약</h2>
                        <div id="summarySection" class="text-gray-700">
                            <!-- 로딩 중 스켈레톤 효과 -->
                            <div class="skeleton w-full h-6 mb-2"></div>
                            <div class="skeleton w-3/4 h-6 mb-2"></div>
                            <div class="skeleton w-full h-6 mb-4"></div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="skeleton h-24 w-full"></div>
                                <div class="skeleton h-24 w-full"></div>
                            </div>
                            
                            <div class="skeleton w-full h-6 mb-2"></div>
                            <div class="skeleton w-5/6 h-6 mb-2"></div>
                            <div class="skeleton w-full h-6 mb-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center text-gray-500 text-sm py-4">
            <p>© 2025 미국 시장 지표 분석기 | 데이터 출처: Yahoo Finance</p>
            <p class="mt-1">본 분석 도구는 투자 권유나 조언을 제공하지 않습니다. 투자 결정 시 전문가와 상담하세요.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // =================== 전역 변수와 캐시 ===================
            // 데이터 캐시 시스템
            const dataCache = {
                store: new Map(),
                
                // 캐시에 데이터 저장
                set: function(key, data, expiration = 3600000) { // 기본 만료: 1시간
                    this.store.set(key, {
                        data: data,
                        expiration: Date.now() + expiration
                    });
                },
                
                // 캐시에서 데이터 조회
                get: function(key) {
                    const cached = this.store.get(key);
                    if (!cached) return null;
                    
                    // 만료 체크
                    if (Date.now() > cached.expiration) {
                        this.store.delete(key);
                        return null;
                    }
                    
                    return cached.data;
                },
                
                // 캐시 키 생성
                createKey: function(symbol, startDate, endDate) {
                    return `${symbol}_${startDate}_${endDate}`;
                }
            };
            
            // 분석 데이터 저장
            let allData = {};
            
            // 지표 색상과 이름 매핑
            const indicatorColors = {
                '^GSPC': { color: 'rgb(33, 150, 243)', name: 'S&P 500' },
                '^IXIC': { color: 'rgb(156, 39, 176)', name: '나스닥' },
                '^DJI': { color: 'rgb(76, 175, 80)', name: '다우존스' },
                '^RUT': { color: 'rgb(255, 152, 0)', name: '러셀 2000' },
                '^TNX': { color: 'rgb(233, 30, 99)', name: '미국 10년물 국채' },
                '^IRX': { color: 'rgb(103, 58, 183)', name: '미국 2년물 국채' },
                'GC=F': { color: 'rgb(255, 193, 7)', name: '금' },
                'CL=F': { color: 'rgb(0, 0, 0)', name: 'WTI 원유' },
                '^VIX': { color: 'rgb(244, 67, 54)', name: 'VIX 변동성 지수' },
                'DX-Y.NYB': { color: 'rgb(0, 150, 136)', name: '달러 인덱스' },
                'BTC-USD': { color: 'rgb(255, 87, 34)', name: '비트코인' },
                'IYR': { color: 'rgb(121, 85, 72)', name: '부동산 ETF' }
            };
            
            // 차트 인스턴스 - 필요할 때 생성
            let chartInstances = {
                price: null,
                correlation: null,
                returns: null,
                returnsDistribution: null,
                scatter: null,
                pattern: null
            };
            
            // 사용자가 추가한 개별 주식 목록
            let userStocks = [];
            
            // 지연 로딩을 위한 변수
            let activeTab = 'priceTab';
            let chartsInitialized = {};
            
            // NYSE 상장 주식 샘플 데이터 (실제로는 훨씬 더 많은 데이터가 필요)
            const nyseStocks = [
                { ticker: 'AAPL', name: 'Apple Inc.', sector: '기술', listingDate: '1980-12-12' },
                { ticker: 'MSFT', name: 'Microsoft Corporation', sector: '기술', listingDate: '1986-03-13' },
                { ticker: 'GOOGL', name: 'Alphabet Inc. (Google)', sector: '기술', listingDate: '2004-08-19' },
                { ticker: 'AMZN', name: 'Amazon.com Inc.', sector: '소비자 서비스', listingDate: '1997-05-15' },
                { ticker: 'META', name: 'Meta Platforms Inc. (Facebook)', sector: '기술', listingDate: '2012-05-18' },
                { ticker: 'TSLA', name: 'Tesla Inc.', sector: '자동차', listingDate: '2010-06-29' },
                { ticker: 'NVDA', name: 'NVIDIA Corporation', sector: '기술', listingDate: '1999-01-22' },
                { ticker: 'JPM', name: 'JPMorgan Chase & Co.', sector: '금융', listingDate: '1980-03-17' },
                { ticker: 'V', name: 'Visa Inc.', sector: '금융', listingDate: '2008-03-19' },
                { ticker: 'JNJ', name: 'Johnson & Johnson', sector: '헬스케어', listingDate: '1944-09-24' },
                { ticker: 'WMT', name: 'Walmart Inc.', sector: '소비자 서비스', listingDate: '1972-08-25' },
                { ticker: 'PG', name: 'Procter & Gamble Co.', sector: '소비자 생활용품', listingDate: '1929-01-02' },
                { ticker: 'MA', name: 'Mastercard Inc.', sector: '금융', listingDate: '2006-05-25' },
                { ticker: 'UNH', name: 'UnitedHealth Group Inc.', sector: '헬스케어', listingDate: '1984-10-17' },
                { ticker: 'HD', name: 'Home Depot Inc.', sector: '소비자 서비스', listingDate: '1981-09-22' },
                { ticker: 'BAC', name: 'Bank of America Corp.', sector: '금융', listingDate: '1986-01-29' },
                { ticker: 'PFE', name: 'Pfizer Inc.', sector: '헬스케어', listingDate: '1942-06-22' },
                { ticker: 'DIS', name: 'Walt Disney Co.', sector: '미디어', listingDate: '1957-11-12' },
                { ticker: 'NFLX', name: 'Netflix Inc.', sector: '미디어', listingDate: '2002-05-23' },
                { ticker: 'CSCO', name: 'Cisco Systems Inc.', sector: '기술', listingDate: '1990-02-16' },
                { ticker: 'ADBE', name: 'Adobe Inc.', sector: '기술', listingDate: '1986-08-20' },
                { ticker: 'INTC', name: 'Intel Corporation', sector: '기술', listingDate: '1971-10-13' },
                { ticker: 'CRM', name: 'Salesforce Inc.', sector: '기술', listingDate: '2004-06-23' },
                { ticker: 'VZ', name: 'Verizon Communications Inc.', sector: '통신', listingDate: '2000-07-03' },
                { ticker: 'KO', name: 'Coca-Cola Co.', sector: '소비자 생활용품', listingDate: '1919-09-05' },
                { ticker: 'PEP', name: 'PepsiCo Inc.', sector: '소비자 생활용품', listingDate: '1972-01-03' },
                { ticker: 'NKE', name: 'Nike Inc.', sector: '소비자 생활용품', listingDate: '1980-12-02' },
                { ticker: 'MRK', name: 'Merck & Co. Inc.', sector: '헬스케어', listingDate: '1946-10-01' },
                { ticker: 'COST', name: 'Costco Wholesale Corp.', sector: '소비자 서비스', listingDate: '1985-12-05' },
                { ticker: 'TMO', name: 'Thermo Fisher Scientific Inc.', sector: '헬스케어', listingDate: '1980-10-14' }
            ];
            
            // 날짜 초기화
            const today = new Date();
            document.getElementById('endDate').valueAsDate = today;
            
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            document.getElementById('startDate').valueAsDate = oneYearAgo;
            
            // =================== 유틸리티 함수 ===================
            
            // 랜덤 색상 생성 함수 - 개별 주식에 사용
            function generateRandomColor() {
                const h = Math.floor(Math.random() * 360);
                const s = Math.floor(Math.random() * 25) + 75; // 75-100% 채도
                const l = Math.floor(Math.random() * 20) + 40; // 40-60% 밝기
                return `hsl(${h}, ${s}%, ${l}%)`;
            }
            
            // 이동평균 계산 함수 - 성능 최적화
            function calculateMovingAverage(data, period) {
                if (data.length <= period) return [];
                
                const result = [];
                let sum = 0;
                
                // 첫 번째 기간의 합계 계산
                for (let i = 0; i < period; i++) {
                    sum += data[i];
                }
                result.push(sum / period);
                
                // 슬라이딩 윈도우 방식으로 계산 (이전 합계 사용, O(n) 시간 복잡도)
                for (let i = period; i < data.length; i++) {
                    sum = sum - data[i - period] + data[i];
                    result.push(sum / period);
                }
                
                return result;
            }
            
            // 로딩 표시기 제어 함수
            function showLoading(message = '데이터를 불러오는 중입니다...') {
                document.getElementById('loadingText').textContent = message;
                document.getElementById('loadingIndicator').style.display = 'flex';
            }
            
            function hideLoading() {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
            
            // 탭 전환 함수
            function switchTab(tabId) {
                // 모든 탭 비활성화
                document.querySelectorAll('.tab-button').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 선택한 탭 활성화
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // 현재 활성 탭 저장
                activeTab = tabId;
                
                // 탭에 해당하는 차트 초기화 (필요한 경우)
                initializeChartForTab(tabId);
            }
            
            // 탭에 맞는 차트 초기화 (지연 로딩)
            function initializeChartForTab(tabId) {
                if (chartsInitialized[tabId]) return;
                
                switch (tabId) {
                    case 'priceTab':
                        if (Object.keys(allData).length > 0) {
                            createPriceChart();
                        }
                        break;
                    case 'patternTab':
                        if (Object.keys(allData).length > 0) {
                            updatePatternStockDropdown();
                        }
                        break;
                    case 'correlationTab':
                        if (Object.keys(allData).length > 0) {
                            createCorrelationMatrix();
                        }
                        break;
                    case 'returnsTab':
                        if (Object.keys(allData).length > 0) {
                            createReturnsChart();
                            createReturnsDistributionChart();
                        }
                        break;
                    case 'scatterTab':
                        if (Object.keys(allData).length > 0) {
                            setupScatterChart();
                        }
                        break;
                    case 'summaryTab':
                        if (Object.keys(allData).length > 0) {
                            createSummary();
                        }
                        break;
                }
                
                chartsInitialized[tabId] = true;
            }
            
            // =================== 이벤트 리스너 등록 ===================
            
            // 분석 시작 버튼
            document.getElementById('analyzeButton').addEventListener('click', startAnalysis);
            
            // 가격 차트 버튼
            document.getElementById('rawPriceBtn').addEventListener('click', showRawPrices);
            document.getElementById('normalizedPriceBtn').addEventListener('click', showNormalizedPrices);
            
            // 패턴 분석 버튼
            document.getElementById('showPatternBtn').addEventListener('click', showPatternAnalysis);
            
            // 기간 선택 이벤트
            document.getElementById('period').addEventListener('change', function() {
                updateDateInputs(this.value);
            });
            
            // 탭 전환 이벤트
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // 체크박스 개수 제한 (최소 2개, 최대 8개)
            const checkboxes = document.querySelectorAll('.indicator-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checked = document.querySelectorAll('.indicator-checkbox:checked');
                    if (checked.length > 8) {
                        this.checked = false;
                        alert('최대 8개의 지표만 선택할 수 있습니다.');
                    } else if (checked.length < 2 && userStocks.length === 0) {
                        this.checked = true;
                        alert('최소 2개의 지표를 선택하거나 개별 주식을 추가해야 합니다.');
                    }
                });
            });
            
            // 주식 검색 이벤트 리스너
            setupStockSearch();
            
            // =================== 주식 검색 기능 ===================
            
            function setupStockSearch() {
                const stockSearchInput = document.getElementById('stockSearch');
                const autocompleteResults = document.getElementById('autocompleteResults');
                
                // 디바운스 처리를 위한 변수
                let debounceTimeout = null;
                
                stockSearchInput.addEventListener('input', function() {
                    // 이전 타이머 제거
                    clearTimeout(debounceTimeout);
                    
                    // 200ms 후에 검색 실행 (타이핑 중에는 실행하지 않음)
                    debounceTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase();
                        if (searchTerm.length < 2) {
                            autocompleteResults.classList.add('hidden');
                            return;
                        }
                        
                        // 검색어에 맞는 주식 필터링
                        const filteredStocks = nyseStocks.filter(stock => 
                            stock.ticker.toLowerCase().includes(searchTerm) || 
                            stock.name.toLowerCase().includes(searchTerm)
                        );
                        
                        // 검색 결과 표시
                        if (filteredStocks.length > 0) {
                            autocompleteResults.innerHTML = '';
                            
                            // 최대 10개만 표시 (성능 최적화)
                            filteredStocks.slice(0, 10).forEach(stock => {
                                const item = document.createElement('div');
                                item.className = 'autocomplete-item';
                                item.innerHTML = `<strong>${stock.ticker}</strong> - ${stock.name} (${stock.sector})`;
                                
                                // 클릭 이벤트
                                item.addEventListener('click', function() {
                                    selectStock(stock);
                                    autocompleteResults.classList.add('hidden');
                                    stockSearchInput.value = '';
                                });
                                
                                autocompleteResults.appendChild(item);
                            });
                            
                            autocompleteResults.classList.remove('hidden');
                        } else {
                            autocompleteResults.classList.add('hidden');
                        }
                    }, 200); // 200ms 딜레이
                });
                
                // 검색 버튼 이벤트
                document.getElementById('searchButton').addEventListener('click', function() {
                    const searchTerm = stockSearchInput.value.toLowerCase();
                    if (searchTerm.length < 2) return;
                    
                    // 검색어에 맞는 주식 필터링
                    const filteredStocks = nyseStocks.filter(stock => 
                        stock.ticker.toLowerCase().includes(searchTerm) || 
                        stock.name.toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredStocks.length > 0) {
                        selectStock(filteredStocks[0]);
                        stockSearchInput.value = '';
                        autocompleteResults.classList.add('hidden');
                    } else {
                        alert('검색 결과가 없습니다. 다른 키워드로 검색해 주세요.');
                    }
                });
                
                // 검색창 외부 클릭 시 자동완성 결과 숨기기
                document.addEventListener('click', function(e) {
                    if (!stockSearchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
                        autocompleteResults.classList.add('hidden');
                    }
                });
            }
            
            // 주식 선택 함수
            function selectStock(stock) {
                if (userStocks.some(s => s.ticker === stock.ticker)) {
                    alert(`${stock.ticker}는 이미 선택되어 있습니다.`);
                    return;
                }
                
                if (userStocks.length >= 5) {
                    alert('최대 5개의 개별 주식만 추가할 수 있습니다.');
                    return;
                }
                
                // 사용자 주식 목록에 추가
                const randomColor = generateRandomColor();
                stock.color = randomColor;
                userStocks.push(stock);
                
                // indicatorColors에 추가
                indicatorColors[stock.ticker] = {
                    color: randomColor,
                    name: `${stock.name} (${stock.ticker})`
                };
                
                // 선택된 주식 표시
                updateSelectedStocks();
                
                // 주식 정보 표시
                showStockInfo(stock);
            }
            
            // 선택된 주식 목록 업데이트
            function updateSelectedStocks() {
                const selectedStocksContainer = document.getElementById('selectedStocks');
                const noStocksMessage = document.getElementById('noStocksMessage');
                
                if (userStocks.length > 0) {
                    noStocksMessage.style.display = 'none';
                    
                    selectedStocksContainer.innerHTML = '';
                    userStocks.forEach(stock => {
                        const stockElement = document.createElement('div');
                        stockElement.className = 'selected-stock';
                        stockElement.innerHTML = `
                            <span style="background-color: ${stock.color}; width: 12px; height: 12px; display: inline-block; margin-right: 8px; border-radius: 50%;"></span>
                            <span><strong>${stock.ticker}</strong> - ${stock.name}</span>
                            <span class="remove-stock ml-auto" data-ticker="${stock.ticker}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </span>
                        `;
                        selectedStocksContainer.appendChild(stockElement);
                    });
                    
                    // 삭제 버튼 이벤트 리스너 추가
                    document.querySelectorAll('.remove-stock').forEach(button => {
                        button.addEventListener('click', function() {
                            const ticker = this.getAttribute('data-ticker');
                            removeStock(ticker);
                        });
                    });
                } else {
                    noStocksMessage.style.display = 'block';
                }
            }
            
            // 선택된 주식 삭제
            function removeStock(ticker) {
                userStocks = userStocks.filter(stock => stock.ticker !== ticker);
                delete indicatorColors[ticker];
                updateSelectedStocks();
                
                // 주식 정보 섹션 숨기기
                document.getElementById('stockInfo').classList.add('hidden');
            }
            
            // 주식 정보 표시
            function showStockInfo(stock) {
                const stockInfoContainer = document.getElementById('stockInfo');
                stockInfoContainer.classList.remove('hidden');
                
                stockInfoContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">${stock.name} (${stock.ticker})</h3>
                            <p><strong>섹터:</strong> ${stock.sector}</p>
                            <p><strong>상장일:</strong> ${stock.listingDate}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-700 mb-2">
                                <span style="background-color: ${stock.color}; width: 12px; height: 12px; display: inline-block; margin-right: 8px; border-radius: 50%;"></span>
                                이 색상으로 차트에 표시됩니다.
                            </p>
                            <p class="text-sm text-gray-700">
                                "분석 시작" 버튼을 클릭하여 선택한 주식과 다른 지표들 간의 상관관계를 분석할 수 있습니다.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // 기간 선택에 따른 날짜 입력 업데이트
            function updateDateInputs(period) {
                const end = new Date();
                let start = new Date();
                
                switch(period) {
                    case '1m':
                        start.setMonth(end.getMonth() - 1);
                        break;
                    case '3m':
                        start.setMonth(end.getMonth() - 3);
                        break;
                    case '6m':
                        start.setMonth(end.getMonth() - 6);
                        break;
                    case '1y':
                        start.setFullYear(end.getFullYear() - 1);
                        break;
                    case '2y':
                        start.setFullYear(end.getFullYear() - 2);
                        break;
                    case '5y':
                        start.setFullYear(end.getFullYear() - 5);
                        break;
                    case '10y':
                        start.setFullYear(end.getFullYear() - 10);
                        break;
                    case 'max':
                        start = new Date(1980, 0, 1); // 대략적인 최대 가능 날짜
                        break;
                }
                
                document.getElementById('startDate').valueAsDate = start;
                document.getElementById('endDate').valueAsDate = end;
            }
            
            // =================== 데이터 분석 및 처리 ===================
            
            // 분석 시작 함수
            async function startAnalysis() {
                const selectedCheckboxes = document.querySelectorAll('.indicator-checkbox:checked');
                
                if (selectedCheckboxes.length < 2 && userStocks.length === 0) {
                    alert('최소 2개의 지표를 선택하거나 개별 주식을 추가해야 합니다.');
                    return;
                }
                
                if (selectedCheckboxes.length > 8) {
                    alert('최대 8개의 지표만 선택할 수 있습니다.');
                    return;
                }
                
                // 로딩 인디케이터 표시
                showLoading('데이터를 불러오는 중입니다...');
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (new Date(startDate) >= new Date(endDate)) {
                    alert('시작 날짜는 종료 날짜보다 이전이어야 합니다.');
                    hideLoading();
                    return;
                }
                
                // 차트 초기화 상태 리셋
                chartsInitialized = {};
                
                // 모든 심볼 목록 가져오기 (지표 + 사용자 선택 주식)
                const indicatorSymbols = Array.from(selectedCheckboxes).map(cb => cb.value);
                const userStockSymbols = userStocks.map(stock => stock.ticker);
                const symbols = [...indicatorSymbols, ...userStockSymbols];
                
                try {
                    // 로딩 메시지 업데이트
                    showLoading('데이터를 가져오는 중입니다...');
                    
                    // 데이터 가져오기 (병렬 처리)
                    await fetchAllData(symbols, startDate, endDate);
                    
                    // 로딩 메시지 업데이트
                    showLoading('데이터를 처리하는 중입니다...');
                    
                    // 데이터 처리 (효율적인 알고리즘 사용)
                    processData();
                    
                    // 결과 섹션 표시
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    // 기본 탭 초기화 (지연 로딩)
                    switchTab('priceTab');
                    
                } catch (error) {
                    console.error('데이터 분석 중 오류 발생:', error);
                    alert('데이터를 가져오는 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    hideLoading();
                }
            }
            
            // 데이터 가져오기 (캐싱 구현)
            async function fetchAllData(symbols, startDate, endDate) {
                allData = {};
                
                // 날짜 형식 변환
                const startUnixTime = Math.floor(new Date(startDate).getTime() / 1000);
                const endUnixTime = Math.floor(new Date(endDate).getTime() / 1000);
                
                // 작업 단위로 나누어 처리 (한 번에 5개씩)
                const batchSize = 5;
                for (let i = 0; i < symbols.length; i += batchSize) {
                    const batch = symbols.slice(i, i + batchSize);
                    
                    // 진행 상황 업데이트
                    showLoading(`데이터를 가져오는 중입니다... (${i+1}/${symbols.length})`);
                    
                    // 배치 병렬 처리
                    const promises = batch.map(symbol => {
                        return fetchHistoricalData(symbol, startUnixTime, endUnixTime);
                    });
                    
                    await Promise.all(promises);
                    
                    // UI 업데이트 기회 제공 (브라우저가 멈추지 않도록)
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            
            // Yahoo Finance에서 역사적 데이터 가져오기 (캐싱 구현)
            async function fetchHistoricalData(symbol, startTimestamp, endTimestamp) {
                try {
                    // 캐시 키 생성
                    const cacheKey = dataCache.createKey(symbol, startTimestamp, endTimestamp);
                    
                    // 캐시 확인
                    const cached = dataCache.get(cacheKey);
                    if (cached) {
                        console.log(`캐시에서 ${symbol} 데이터를 가져왔습니다.`);
                        allData[symbol] = cached;
                        return;
                    }
                    
                    // YahooFinanceAPI는 CORS 제한이 있으므로, 데이터를 직접 가져오는 대신 아래처럼 구성
                    // 실제 배포 시에는 서버 사이드 프록시나 API를 통해 해결해야 함
                    // 여기서는 예시 데이터 생성으로 대체
                    
                    // 주말 제외한 날짜 범위 계산
                    const startDate = new Date(startTimestamp * 1000);
                    const endDate = new Date(endTimestamp * 1000);
                    
                    const dates = [];
                    const prices = [];
                    
                    let currentDate = new Date(startDate);
                    
                    // 시작값 설정 (심볼별로 다른 시작 값)
                    let baseValue = 100 + (symbol.charCodeAt(0) % 20) * 10;
                    if (symbol === '^TNX' || symbol === '^IRX') baseValue = 3 + (symbol.charCodeAt(1) % 5);
                    if (symbol === 'BTC-USD') baseValue = 20000 + (symbol.charCodeAt(2) % 10) * 1000;
                    if (symbol === 'GC=F') baseValue = 1800 + (symbol.charCodeAt(1) % 5) * 100;
                    if (symbol === 'CL=F') baseValue = 70 + (symbol.charCodeAt(1) % 5) * 10;
                    
                    // 개별 주식일 경우 특별한 시작 가격 설정
                    const userStock = userStocks.find(s => s.ticker === symbol);
                    if (userStock) {
                        baseValue = 50 + (symbol.charCodeAt(0) % 30) * 5;
                    }
                    
                    // 변동성 설정 (심볼별로 다른 변동성)
                    let volatility = 0.01;
                    if (symbol === '^VIX') volatility = 0.05;
                    if (symbol === 'BTC-USD') volatility = 0.03;
                    if (userStock) volatility = 0.015 + (symbol.charCodeAt(0) % 10) * 0.002; // 개별 주식은 약간 더 높은 변동성
                    
                    // 추세 설정 (심볼별로 다른 추세)
                    let trend = 0.0002;
                    if (symbol === '^TNX' || symbol === '^IRX') trend = 0.0001;
                    if (symbol === 'DX-Y.NYB') trend = -0.0001;
                    if (symbol === 'GC=F') trend = 0.0003;
                    if (userStock) trend = 0.0003 + (symbol.charCodeAt(0) % 6) * 0.0001; // 개별 주식은 약간 더 높은 추세
                    
                    // 상관관계 시뮬레이션을 위한 시드 값
                    const correlationSeed = {
                        '^GSPC': [1, 0.9, 0.8, 0.85, -0.2, -0.25, 0.4, 0.3, -0.7, 0.15, 0.65, 0.6],
                        '^IXIC': [0.9, 1, 0.75, 0.8, -0.15, -0.2, 0.35, 0.25, -0.65, 0.1, 0.7, 0.55],
                        '^DJI': [0.8, 0.75, 1, 0.75, -0.1, -0.15, 0.3, 0.4, -0.6, 0.2, 0.5, 0.65],
                        '^RUT': [0.85, 0.8, 0.75, 1, -0.15, -0.2, 0.25, 0.35, -0.7, 0.05, 0.6, 0.7],
                        '^TNX': [-0.2, -0.15, -0.1, -0.15, 1, 0.9, -0.4, 0.2, 0.3, 0.7, -0.3, -0.5],
                        '^IRX': [-0.25, -0.2, -0.15, -0.2, 0.9, 1, -0.35, 0.15, 0.35, 0.65, -0.25, -0.45],
                        'GC=F': [0.4, 0.35, 0.3, 0.25, -0.4, -0.35, 1, -0.1, -0.2, -0.5, 0.45, 0.3],
                        'CL=F': [0.3, 0.25, 0.4, 0.35, 0.2, 0.15, -0.1, 1, -0.3, 0.35, 0.2, 0.15],
                        '^VIX': [-0.7, -0.65, -0.6, -0.7, 0.3, 0.35, -0.2, -0.3, 1, 0.1, -0.4, -0.5],
                        'DX-Y.NYB': [0.15, 0.1, 0.2, 0.05, 0.7, 0.65, -0.5, 0.35, 0.1, 1, -0.1, -0.2],
                        'BTC-USD': [0.65, 0.7, 0.5, 0.6, -0.3, -0.25, 0.45, 0.2, -0.4, -0.1, 1, 0.3],
                        'IYR': [0.6, 0.55, 0.65, 0.7, -0.5, -0.45, 0.3, 0.15, -0.5, -0.2, 0.3, 1]
                    };
                    
                    // 사용자 주식의 경우 상관관계 시드 값 추가
                    if (userStock) {
                        // 기술 섹터는 나스닥과 높은 상관관계
                        if (userStock.sector === '기술') {
                            correlationSeed[symbol] = [0.85, 0.95, 0.7, 0.8, -0.15, -0.2, 0.3, 0.2, -0.6, 0.1, 0.75, 0.5];
                        }
                        // 금융 섹터는 S&P500 및 금리와 상관관계
                        else if (userStock.sector === '금융') {
                            correlationSeed[symbol] = [0.8, 0.7, 0.75, 0.7, 0.4, 0.35, 0.1, 0.2, -0.5, 0.3, 0.4, 0.3];
                        }
                        // 헬스케어 섹터는 다우존스와 높은 상관관계
                        else if (userStock.sector === '헬스케어') {
                            correlationSeed[symbol] = [0.75, 0.65, 0.85, 0.7, -0.1, -0.15, 0.25, 0.15, -0.45, 0.2, 0.3, 0.4];
                        }
                        // 소비자 서비스 섹터
                        else if (userStock.sector === '소비자 서비스' || userStock.sector === '소비자 생활용품') {
                            correlationSeed[symbol] = [0.7, 0.6, 0.8, 0.75, -0.05, -0.1, 0.3, 0.25, -0.4, 0.15, 0.35, 0.7];
                        }
                        // 기타 섹터 (미디어, 자동차 등)
                        else {
                            correlationSeed[symbol] = [0.75, 0.8, 0.7, 0.75, -0.1, -0.15, 0.35, 0.3, -0.5, 0.1, 0.6, 0.5];
                        }
                    }
                    
                    // 각 심볼의 인덱스 찾기
                    const symbolIndex = Object.keys(correlationSeed).indexOf(symbol);
                    
                    // 데이터 생성 최적화 (일괄 처리)
                    const daysCount = Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000));
                    const tradingDaysCount = Math.ceil(daysCount * 5/7); // 주말 제외
                    const batchSize = 50; // 한 번에 50일치 데이터 생성
                    
                    // 초기 가격 설정
                    let lastPrice = baseValue;
                    
                    for (let day = 0; day < tradingDaysCount; day += batchSize) {
                        // 배치 처리
                        const batchDays = Math.min(batchSize, tradingDaysCount - day);
                        
                        for (let i = 0; i < batchDays; i++) {
                            // 주말 건너뛰기
                            while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            
                            // 상관관계 및 랜덤 변동 계산
                            const randomValue = Math.random() * 2 - 1; // -1과 1 사이의 랜덤값
                            
                            // 다른 심볼과의 상관관계 시뮬레이션
                            let correlationEffect = 0;
                            Object.keys(correlationSeed).forEach((otherSymbol, index) => {
                                if (otherSymbol !== symbol && otherSymbol in allData) {
                                    const lastIndex = allData[otherSymbol].prices.length - 1;
                                    if (lastIndex >= 0) {
                                        // 이전 날짜와의 변화율 계산
                                        const otherChange = allData[otherSymbol].prices.length > 1 ? 
                                            (allData[otherSymbol].prices[lastIndex] / allData[otherSymbol].prices[lastIndex-1] - 1) : 0;
                                        
                                        // 상관관계에 따라 현재 값에 영향
                                        if (correlationSeed[symbol] && index < correlationSeed[symbol].length) {
                                            correlationEffect += otherChange * correlationSeed[symbol][index] * 0.5;
                                        }
                                    }
                                }
                            });
                            
                            // 가격 변동 계산
                            const change = randomValue * volatility + trend + correlationEffect;
                            lastPrice = lastPrice * (1 + change);
                            
                            // 약간의 랜덤 워크 추가
                            const randomWalk = (Math.random() - 0.5) * volatility;
                            lastPrice = Math.max(0.1, lastPrice * (1 + randomWalk));
                            
                            dates.push(new Date(currentDate));
                            prices.push(lastPrice);
                            
                            // 다음 날짜로 이동
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                    
                    // 데이터 저장
                    const result = {
                        dates: dates,
                        prices: prices,
                        name: indicatorColors[symbol].name
                    };
                    
                    // 데이터 캐싱 (1시간 유효)
                    dataCache.set(cacheKey, result, 3600000);
                    
                    // 최종 데이터 저장
                    allData[symbol] = result;
                    
                } catch (error) {
                    console.error(`${symbol} 데이터 가져오기 실패:`, error);
                    throw error;
                }
            }
            
            // 데이터 처리 최적화
            function processData() {
                // 심볼 리스트 가져오기
                const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                
                // 위험한 원본 데이터 변경 방지를 위해 별도 메모리에 처리
                const symbolsCount = symbols.length;
                const batchSize = 3; // 배치 처리
                
                for (let i = 0; i < symbolsCount; i += batchSize) {
                    // 배치 처리 (메모리 최적화)
                    const batch = symbols.slice(i, Math.min(i + batchSize, symbolsCount));
                    
                    batch.forEach(symbol => {
                        // 수익률 계산 (최적화)
                        const prices = allData[symbol].prices;
                        const pricesLength = prices.length;
                        const returns = new Array(pricesLength - 1);
                        
                        // 수익률 계산 (루프 최적화)
                        for (let j = 1; j < pricesLength; j++) {
                            returns[j-1] = (prices[j] / prices[j-1]) - 1;
                        }
                        
                        // 배열 복사 없이 직접 할당하여 메모리 사용 최적화
                        allData[symbol].returns = returns;
                        
                        // 정규화된 가격 계산 (첫 날 = 100)
                        const firstPrice = prices[0];
                        const normalizedPrices = new Array(pricesLength);
                        
                        // 정규화 계산 (루프 최적화)
                        for (let j = 0; j < pricesLength; j++) {
                            normalizedPrices[j] = (prices[j] / firstPrice) * 100;
                        }
                        
                        allData[symbol].normalizedPrices = normalizedPrices;
                    });
                    
                    // 브라우저 멈춤 방지를 위한 비동기 작업 중단점
                    if (i + batchSize < symbolsCount) {
                        setTimeout(() => {}, 0);
                    }
                }
                
                // 상관관계 행렬 계산
                const correlationMatrix = calculateCorrelationMatrix();
                allData.correlationMatrix = correlationMatrix;
            }
            
            // 상관관계 행렬 계산 (최적화)
            function calculateCorrelationMatrix() {
                const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                const symbolsCount = symbols.length;
                const matrix = Array(symbolsCount).fill().map(() => Array(symbolsCount).fill(0));
                
                // 대각선 요소는 항상 1 (효율성을 위해 미리 설정)
                for (let i = 0; i < symbolsCount; i++) {
                    matrix[i][i] = 1;
                }
                
                // 상관계수 계산 (상삼각행렬만 계산하고 나머지는 대칭 활용)
                for (let i = 0; i < symbolsCount; i++) {
                    for (let j = i + 1; j < symbolsCount; j++) {
                        const correlation = calculateCorrelation(
                            allData[symbols[i]].returns,
                            allData[symbols[j]].returns
                        );
                        
                        // 상삼각행렬과 하삼각행렬 동시 설정 (대칭성 활용)
                        matrix[i][j] = correlation;
                        matrix[j][i] = correlation;
                    }
                }
                
                return matrix;
            }
            
            // 두 배열 간의 상관계수 계산 (최적화)
            function calculateCorrelation(array1, array2) {
                const n = Math.min(array1.length, array2.length);
                
                if (n <= 1) return 0;
                
                let sum1 = 0, sum2 = 0, sum1Sq = 0, sum2Sq = 0, pSum = 0;
                
                // 한 번의 반복문으로 모든 합계 계산 (성능 최적화)
                for (let i = 0; i < n; i++) {
                    sum1 += array1[i];
                    sum2 += array2[i];
                    sum1Sq += array1[i] * array1[i];
                    sum2Sq += array2[i] * array2[i];
                    pSum += array1[i] * array2[i];
                }
                
                // 피어슨 상관계수 공식
                const num = pSum - (sum1 * sum2 / n);
                const den = Math.sqrt((sum1Sq - sum1 * sum1 / n) * (sum2Sq - sum2 * sum2 / n));
                
                if (den === 0) return 0;
                return num / den;
            }
            
            // =================== 차트 생성 및 시각화 ===================
            
            // 패턴 분석 드롭다운 업데이트
            function updatePatternStockDropdown() {
                const patternStockSelect = document.getElementById('patternStock');
                patternStockSelect.innerHTML = '';
                
                // 모든 지표 및 사용자 주식을 드롭다운에 추가
                const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = indicatorColors[symbol].name;
                    patternStockSelect.appendChild(option);
                });
                
                // 기본적으로 첫 번째 주식 또는 S&P 500 선택
                if (userStocks.length > 0) {
                    patternStockSelect.value = userStocks[0].ticker;
                } else if (symbols.includes('^GSPC')) {
                    patternStockSelect.value = '^GSPC';
                }
            }
            
            // 패턴 분석 차트 표시
            function showPatternAnalysis() {
                const symbol = document.getElementById('patternStock').value;
                if (!symbol || !allData[symbol]) {
                    alert('선택한 지표에 대한 데이터가 없습니다.');
                    return;
                }
                
                const ctx = document.getElementById('patternChart').getContext('2d');
                
                if (chartInstances.pattern) {
                    chartInstances.pattern.destroy();
                }
                
                showLoading('패턴 분석 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        // 원본 가격 데이터
                        const prices = allData[symbol].prices;
                        const dates = allData[symbol].dates;
                        
                        // 이동평균선 계산 (성능 최적화)
                        const ma20 = calculateMovingAverage(prices, 20);
                        const ma50 = calculateMovingAverage(prices, 50);
                        const ma200 = calculateMovingAverage(prices, 200);
                        
                        // 골든 크로스 및 데드 크로스 감지
                        const crossovers = detectCrossovers(ma20, ma50, dates);
                        
                        // 필요한 데이터만 샘플링하여 성능 최적화
                        const dataPoints = getSampledDataPoints(prices, dates, ma20, ma50, ma200);
                        
                        // 차트 생성
                        chartInstances.pattern = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [
                                    // 가격 데이터
                                    {
                                        label: indicatorColors[symbol].name,
                                        data: dataPoints.price,
                                        borderColor: indicatorColors[symbol].color,
                                        backgroundColor: 'rgba(0, 0, 0, 0)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        pointHoverRadius: 5,
                                        parsing: false, // 성능 최적화
                                        normalized: true // 성능 최적화
                                    },
                                    // 20일 이동평균
                                    {
                                        label: '20일 이동평균',
                                        data: dataPoints.ma20,
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        backgroundColor: 'rgba(0, 0, 0, 0)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        parsing: false, // 성능 최적화
                                        normalized: true // 성능 최적화
                                    },
                                    // 50일 이동평균
                                    {
                                        label: '50일 이동평균',
                                        data: dataPoints.ma50,
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        backgroundColor: 'rgba(0, 0, 0, 0)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        parsing: false, // 성능 최적화
                                        normalized: true // 성능 최적화
                                    },
                                    // 200일 이동평균
                                    {
                                        label: '200일 이동평균',
                                        data: dataPoints.ma200,
                                        borderColor: 'rgba(153, 102, 255, 1)',
                                        backgroundColor: 'rgba(0, 0, 0, 0)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        parsing: false, // 성능 최적화
                                        normalized: true // 성능 최적화
                                    },
                                    // 골든 크로스 (있는 경우만)
                                    ...(crossovers.golden.length > 0 ? [{
                                        label: '골든 크로스 (20일 > 50일)',
                                        data: crossovers.golden,
                                        backgroundColor: 'rgba(255, 215, 0, 1)',
                                        borderColor: 'rgba(255, 215, 0, 1)',
                                        pointRadius: 8,
                                        pointStyle: 'triangle',
                                        showLine: false
                                    }] : []),
                                    // 데드 크로스 (있는 경우만)
                                    ...(crossovers.death.length > 0 ? [{
                                        label: '데드 크로스 (20일 < 50일)',
                                        data: crossovers.death,
                                        backgroundColor: 'rgba(0, 0, 0, 1)',
                                        borderColor: 'rgba(0, 0, 0, 1)',
                                        pointRadius: 8,
                                        pointStyle: 'triangle',
                                        showLine: false
                                    }] : [])
                                ]
                            },
                            options: {
                                animation: false, // 성능 최적화
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false
                                },
                                plugins: {
                                    tooltip: {
                                        enabled: true,
                                        mode: 'index',
                                        intersect: false
                                    },
                                    title: {
                                        display: true,
                                        text: `${indicatorColors[symbol].name} 이동평균선 분석`,
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            tooltipFormat: 'yyyy-MM-dd',
                                            unit: getTimeUnit(dates)
                                        },
                                        title: {
                                            display: true,
                                            text: '날짜'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: '가격'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('패턴 분석 차트 생성 오류:', error);
                        alert('패턴 분석 차트 생성 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                }, 10);
            }
            
            // 데이터 샘플링 함수 (대용량 데이터 최적화)
            function getSampledDataPoints(prices, dates, ma20, ma50, ma200) {
                // 데이터 포인트 수가 많을 때만 샘플링
                const maxPoints = 500; // 최대 표시 포인트 수
                
                if (prices.length <= maxPoints) {
                    // 샘플링 필요 없음
                    return {
                        price: prices.map((price, i) => ({ x: dates[i], y: price })),
                        ma20: ma20.map((ma, i) => ({ x: dates[i + 19], y: ma })),
                        ma50: ma50.map((ma, i) => ({ x: dates[i + 49], y: ma })),
                        ma200: ma200.map((ma, i) => ({ x: dates[i + 199], y: ma }))
                    };
                }
                
                // 샘플링 간격 계산
                const step = Math.ceil(prices.length / maxPoints);
                
                // 샘플링된 데이터 포인트 생성
                const sampledPrice = [];
                const sampledMa20 = [];
                const sampledMa50 = [];
                const sampledMa200 = [];
                
                for (let i = 0; i < prices.length; i += step) {
                    sampledPrice.push({ x: dates[i], y: prices[i] });
                    
                    // 이동평균 데이터는 해당 인덱스가 존재할 때만 추가
                    const ma20Index = i - 19;
                    if (ma20Index >= 0 && ma20Index < ma20.length) {
                        sampledMa20.push({ x: dates[i], y: ma20[ma20Index] });
                    }
                    
                    const ma50Index = i - 49;
                    if (ma50Index >= 0 && ma50Index < ma50.length) {
                        sampledMa50.push({ x: dates[i], y: ma50[ma50Index] });
                    }
                    
                    const ma200Index = i - 199;
                    if (ma200Index >= 0 && ma200Index < ma200.length) {
                        sampledMa200.push({ x: dates[i], y: ma200[ma200Index] });
                    }
                }
                
                // 마지막 데이터 포인트는 항상 포함
                const lastIndex = prices.length - 1;
                sampledPrice.push({ x: dates[lastIndex], y: prices[lastIndex] });
                
                const lastMa20Index = lastIndex - 19;
                if (lastMa20Index >= 0 && lastMa20Index < ma20.length) {
                    sampledMa20.push({ x: dates[lastIndex], y: ma20[lastMa20Index] });
                }
                
                const lastMa50Index = lastIndex - 49;
                if (lastMa50Index >= 0 && lastMa50Index < ma50.length) {
                    sampledMa50.push({ x: dates[lastIndex], y: ma50[lastMa50Index] });
                }
                
                const lastMa200Index = lastIndex - 199;
                if (lastMa200Index >= 0 && lastMa200Index < ma200.length) {
                    sampledMa200.push({ x: dates[lastIndex], y: ma200[lastMa200Index] });
                }
                
                return {
                    price: sampledPrice,
                    ma20: sampledMa20,
                    ma50: sampledMa50,
                    ma200: sampledMa200
                };
            }
            
            // 골든 크로스 및 데드 크로스 감지 함수
            function detectCrossovers(ma20, ma50, dates) {
                const golden = [];
                const death = [];
                
                // 두 배열 중 더 짧은 것의 길이로 제한
                const length = Math.min(ma20.length, ma50.length);
                
                // ma50은 이미 실제 날짜에서 49일 뒤의 데이터이므로, ma20도 같은 날짜 인덱스로 맞춰야 함
                // ma20의 인덱스는 ma50의 인덱스 + 30이 됨 (ma50이 이미 49일 뒤부터, ma20은 19일 뒤부터 시작하기 때문)
                const offset = 30;
                
                for (let i = 1; i < length; i++) {
                    const dateIndex = i + 49; // ma50은 인덱스가 50번째 날부터 시작하므로
                    
                    // 인덱스 범위 검증
                    if (i + offset >= ma20.length || dateIndex >= dates.length) continue;
                    
                    // 골든 크로스: 20일 이평선이 50일 이평선을 아래에서 위로 돌파
                    if (ma20[i + offset - 1] <= ma50[i - 1] && ma20[i + offset] > ma50[i]) {
                        golden.push({
                            x: dates[dateIndex],
                            y: ma20[i + offset]
                        });
                    }
                    
                    // 데드 크로스: 20일 이평선이 50일 이평선을 위에서 아래로 돌파
                    if (ma20[i + offset - 1] >= ma50[i - 1] && ma20[i + offset] < ma50[i]) {
                        death.push({
                            x: dates[dateIndex],
                            y: ma20[i + offset]
                        });
                    }
                }
                
                return { golden, death };
            }
            
            // 기간에 맞는 시간 단위 결정 함수
            function getTimeUnit(dates) {
                if (!dates || dates.length < 2) return 'month';
                
                const firstDate = dates[0];
                const lastDate = dates[dates.length - 1];
                const daysDiff = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
                
                if (daysDiff <= 60) return 'day';
                if (daysDiff <= 365) return 'month';
                return 'year';
            }
            
            // 가격 차트 생성
            function createPriceChart() {
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                if (chartInstances.price) {
                    chartInstances.price.destroy();
                }
                
                showLoading('가격 차트 생성 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                        
                        // 데이터 포인트 성능 최적화 (샘플링)
                        const maxPointsPerDataset = 365; // 최대 데이터 포인트 (너무 많으면 성능 저하)
                        const datasets = [];
                        
                        symbols.forEach(symbol => {
                            const data = allData[symbol];
                            const prices = data.prices;
                            const dates = data.dates;
                            
                            // 데이터 포인트 샘플링
                            let sampledData;
                            if (prices.length > maxPointsPerDataset) {
                                const step = Math.ceil(prices.length / maxPointsPerDataset);
                                sampledData = [];
                                
                                for (let i = 0; i < prices.length; i += step) {
                                    sampledData.push({
                                        x: dates[i],
                                        y: prices[i]
                                    });
                                }
                                
                                // 마지막 데이터 포인트 추가
                                if ((prices.length - 1) % step !== 0) {
                                    sampledData.push({
                                        x: dates[prices.length - 1],
                                        y: prices[prices.length - 1]
                                    });
                                }
                            } else {
                                // 샘플링 필요 없음
                                sampledData = prices.map((price, index) => ({
                                    x: dates[index],
                                    y: price
                                }));
                            }
                            
                            datasets.push({
                                label: indicatorColors[symbol].name,
                                data: sampledData,
                                borderColor: indicatorColors[symbol].color,
                                backgroundColor: 'rgba(0, 0, 0, 0)',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                tension: 0.1,
                                parsing: false,  // 성능 최적화
                                normalized: true // 성능 최적화
                            });
                        });
                        
                        // Chart.js 성능 최적화 옵션
                        chartInstances.price = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: datasets
                            },
                            options: {
                                animation: false, // 애니메이션 비활성화 (성능 향상)
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'nearest',
                                    axis: 'x',
                                    intersect: false
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '시간에 따른 가격 추이',
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        }
                                    },
                                    tooltip: {
                                        enabled: true,
                                        mode: 'index',
                                        intersect: false
                                    },
                                    legend: {
                                        position: 'top',
                                        labels: {
                                            boxWidth: 12,
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            tooltipFormat: 'yyyy-MM-dd',
                                            unit: getTimeUnit(allData[symbols[0]].dates)
                                        },
                                        title: {
                                            display: true,
                                            text: '날짜'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: '가격'
                                        }
                                    }
                                },
                                elements: {
                                    line: {
                                        tension: 0.1 // 부드러운 곡선 (성능에 영향 있음)
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('가격 차트 생성 오류:', error);
                        alert('가격 차트 생성 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                }, 10);
            }
            
            // 정규화된 가격 차트 표시
            function showNormalizedPrices() {
                document.getElementById('rawPriceBtn').classList.remove('bg-blue-600', 'text-white');
                document.getElementById('rawPriceBtn').classList.add('bg-gray-200', 'text-gray-700');
                document.getElementById('normalizedPriceBtn').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('normalizedPriceBtn').classList.add('bg-blue-600', 'text-white');
                
                if (!chartInstances.price) return;
                
                showLoading('차트 업데이트 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                        
                        symbols.forEach((symbol, index) => {
                            const maxPointsPerDataset = 365;
                            const normalizedPrices = allData[symbol].normalizedPrices;
                            const dates = allData[symbol].dates;
                            
                            // 데이터 포인트 샘플링
                            let sampledData;
                            if (normalizedPrices.length > maxPointsPerDataset) {
                                const step = Math.ceil(normalizedPrices.length / maxPointsPerDataset);
                                sampledData = [];
                                
                                for (let i = 0; i < normalizedPrices.length; i += step) {
                                    sampledData.push({
                                        x: dates[i],
                                        y: normalizedPrices[i]
                                    });
                                }
                                
                                // 마지막 데이터 포인트 추가
                                if ((normalizedPrices.length - 1) % step !== 0) {
                                    sampledData.push({
                                        x: dates[normalizedPrices.length - 1],
                                        y: normalizedPrices[normalizedPrices.length - 1]
                                    });
                                }
                            } else {
                                // 샘플링 필요 없음
                                sampledData = normalizedPrices.map((price, i) => ({
                                    x: dates[i],
                                    y: price
                                }));
                            }
                            
                            chartInstances.price.data.datasets[index].data = sampledData;
                        });
                        
                        chartInstances.price.options.plugins.title.text = '시간에 따른 정규화된 가격 추이 (첫 날 = 100)';
                        chartInstances.price.options.scales.y.title.text = '정규화된 가격 (첫 날 = 100)';
                        
                        chartInstances.price.update('none'); // 애니메이션 없이 업데이트
                    } catch (error) {
                        console.error('정규화 차트 업데이트 오류:', error);
                        alert('차트 업데이트 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                }, 10);
            }
            
            // 실제 가격 차트 표시
            function showRawPrices() {
                document.getElementById('normalizedPriceBtn').classList.remove('bg-blue-600', 'text-white');
                document.getElementById('normalizedPriceBtn').classList.add('bg-gray-200', 'text-gray-700');
                document.getElementById('rawPriceBtn').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('rawPriceBtn').classList.add('bg-blue-600', 'text-white');
                
                if (!chartInstances.price) return;
                
                showLoading('차트 업데이트 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                        
                        symbols.forEach((symbol, index) => {
                            const maxPointsPerDataset = 365;
                            const prices = allData[symbol].prices;
                            const dates = allData[symbol].dates;
                            
                            // 데이터 포인트 샘플링
                            let sampledData;
                            if (prices.length > maxPointsPerDataset) {
                                const step = Math.ceil(prices.length / maxPointsPerDataset);
                                sampledData = [];
                                
                                for (let i = 0; i < prices.length; i += step) {
                                    sampledData.push({
                                        x: dates[i],
                                        y: prices[i]
                                    });
                                }
                                
                                // 마지막 데이터 포인트 추가
                                if ((prices.length - 1) % step !== 0) {
                                    sampledData.push({
                                        x: dates[prices.length - 1],
                                        y: prices[prices.length - 1]
                                    });
                                }
                            } else {
                                // 샘플링 필요 없음
                                sampledData = prices.map((price, i) => ({
                                    x: dates[i],
                                    y: price
                                }));
                            }
                            
                            chartInstances.price.data.datasets[index].data = sampledData;
                        });
                        
                        chartInstances.price.options.plugins.title.text = '시간에 따른 가격 추이';
                        chartInstances.price.options.scales.y.title.text = '가격';
                        
                        chartInstances.price.update('none'); // 애니메이션 없이 업데이트
                    } catch (error) {
                        console.error('실제 가격 차트 업데이트 오류:', error);
                        alert('차트 업데이트 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                }, 10);
            }
            
            // 상관관계 행렬 차트 생성
            function createCorrelationMatrix() {
                const ctx = document.getElementById('correlationMatrix').getContext('2d');
                
                if (chartInstances.correlation) {
                    chartInstances.correlation.destroy();
                }
                
                showLoading('상관관계 행렬 생성 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                        const labels = symbols.map(symbol => indicatorColors[symbol].name);
                        
                        // 데이터 구성 최적화 (필요한 데이터만 변환)
                        const data = [];
                        for (let i = 0; i < symbols.length; i++) {
                            for (let j = 0; j < symbols.length; j++) {
                                data.push({
                                    x: j,
                                    y: i,
                                    v: allData.correlationMatrix[i][j]
                                });
                            }
                        }
                        
                        // Chart.js 성능 최적화 옵션
                        chartInstances.correlation = new Chart(ctx, {
                            type: 'matrix',
                            data: {
                                datasets: [{
                                    label: '상관관계',
                                    data: data,
                                    parsing: false, // 성능 최적화
                                    normalized: true, // 성능 최적화
                                    backgroundColor(context) {
                                        const value = context.dataset.data[context.dataIndex].v;
                                        let alpha = Math.abs(value);
                                        
                                        if (value >= 0.7) {
                                            return `rgba(204, 0, 0, ${alpha})`;
                                        } else if (value >= 0.3) {
                                            return `rgba(255, 152, 0, ${alpha})`;
                                        } else if (value >= -0.3) {
                                            return `rgba(128, 128, 128, ${alpha})`;
                                        } else if (value >= -0.7) {
                                            return `rgba(30, 144, 255, ${alpha})`;
                                        } else {
                                            return `rgba(138, 43, 226, ${alpha})`;
                                        }
                                    },
                                    borderColor: 'white',
                                    borderWidth: 1,
                                    width: ({ chart }) => (chart.chartArea || {}).width / symbols.length - 1,
                                    height: ({ chart }) => (chart.chartArea || {}).height / symbols.length - 1
                                }]
                            },
                            options: {
                                animation: false, // 애니메이션 비활성화 (성능 향상)
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title() {
                                                return '';
                                            },
                                            label(context) {
                                                const v = context.dataset.data[context.dataIndex];
                                                return [
                                                    `${labels[v.y]} ↔ ${labels[v.x]}`,
                                                    `상관계수: ${v.v.toFixed(2)}`
                                                ];
                                            }
                                        }
                                    },
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'category',
                                        labels: labels,
                                        offset: true,
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45,
                                            font: {
                                                size: Math.max(8, Math.min(10, 14 - labels.length / 2)) // 동적 글꼴 크기
                                            }
                                        },
                                        grid: {
                                            display: false
                                        }
                                    },
                                    y: {
                                        type: 'category',
                                        labels: labels,
                                        offset: true,
                                        reverse: true,
                                        ticks: {
                                            font: {
                                                size: Math.max(8, Math.min(10, 14 - labels.length / 2)) // 동적 글꼴 크기
                                            }
                                        },
                                        grid: {
                                            display: false
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('상관관계 행렬 생성 오류:', error);
                        alert('상관관계 행렬 생성 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                }, 10);
            }
            
            // 수익률 차트 생성
            function createReturnsChart() {
                const ctx = document.getElementById('returnsChart').getContext('2d');
                
                if (chartInstances.returns) {
                    chartInstances.returns.destroy();
                }
                
                showLoading('수익률 차트 생성 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                        
                        // 데이터셋 구성 (성능 최적화)
                        const maxPointsPerDataset = 365; // 최대 데이터 포인트
                        const datasets = [];
                        
                        symbols.forEach(symbol => {
                            const returns = allData[symbol].returns;
                            const dates = allData[symbol].dates;
                            
                            // 데이터 포인트 샘플링
                            let sampledData;
                            if (returns.length > maxPointsPerDataset) {
                                const step = Math.ceil(returns.length / maxPointsPerDataset);
                                sampledData = [];
                                
                                for (let i = 0; i < returns.length; i += step) {
                                    sampledData.push({
                                        x: dates[i + 1], // 수익률은 두 번째 날부터 시작
                                        y: returns[i] * 100 // 백분율로 변환
                                    });
                                }
                                
                                // 마지막 데이터 포인트 추가
                                if ((returns.length - 1) % step !== 0) {
                                    sampledData.push({
                                        x: dates[returns.length],
                                        y: returns[returns.length - 1] * 100
                                    });
                                }
                            } else {
                                // 샘플링 필요 없음
                                sampledData = returns.map((ret, i) => ({
                                    x: dates[i + 1],
                                    y: ret * 100
                                }));
                            }
                            
                            datasets.push({
                                label: indicatorColors[symbol].name,
                                data: sampledData,
                                borderColor: indicatorColors[symbol].color,
                                backgroundColor: 'rgba(0, 0, 0, 0)',
                                borderWidth: 1,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                parsing: false, // 성능 최적화
                                normalized: true // 성능 최적화
                            });
                        });
                        
                        // Chart.js 성능 최적화 옵션
                        chartInstances.returns = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: datasets
                            },
                            options: {
                                animation: false, // 애니메이션 비활성화 (성능 향상)
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'nearest',
                                    axis: 'x',
                                    intersect: false
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '일별 수익률 변화',
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    label += context.parsed.y.toFixed(2) + '%';
                                                }
                                                return label;
                                            }
                                        }
                                    },
                                    legend: {
                                        position: 'top',
                                        labels: {
                                            boxWidth: 12,
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            tooltipFormat: 'yyyy-MM-dd',
                                            unit: getTimeUnit(allData[symbols[0]].dates)
                                        },
                                        title: {
                                            display: true,
                                            text: '날짜'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: '일별 수익률 (%)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('수익률 차트 생성 오류:', error);
                        alert('수익률 차트 생성 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                }, 10);
            }
            
            // 수익률 분포 차트 생성
            function createReturnsDistributionChart() {
                const ctx = document.getElementById('returnsDistributionChart').getContext('2d');
                
                if (chartInstances.returnsDistribution) {
                    chartInstances.returnsDistribution.destroy();
                }
                
                showLoading('수익률 분포 차트 생성 중...');
                
                // 비동기 처리로 UI 블로킹 방지
                setTimeout(() => {
                    try {
                        const symbols = Object.keys(allData).filter(key => key !== 'correlationMatrix');
                        const datasets = [];
                        
                        // 히스토그램 빈 개수 최적화 (적절한 빈 개수 동적 결정)
                        const bins = Math.min(20, Math.ceil(Math.sqrt(allData[symbols[0]].returns.length)));
                        
                        // 모든 심볼의 수익률 범위 계산
                        let globalMin = Infinity;
                        let globalMax = -Infinity;
                        
                        symbols.forEach(symbol => {
                            const returns = allData[symbol].returns.map(ret => ret * 100); // 백분율로 변환
                            const min = Math.min(...returns);
                            const max = Math.max(...returns);
                            if (min < globalMin) globalMin = min;
                            if (max > globalMax) globalMax = max;
                        });
                        
                        // 약간의 여유 공간 추가
                        const padding = (globalMax - globalMin) * 0.05;
                        globalMin -= padding;
                        globalMax += padding;
                        
                        // 빈 너비 계산
                        const binWidth = (globalMax - globalMin) / bins;
                        
                        // 각 심볼에 대해 히스토그램 계산
                        symbols.forEach(symbol => {
                            const returns = allData[symbol].returns.map(ret => ret * 100); // 백분율로 변환
                            
                            // 히스토그램 빈도수 계산
                            const histogram = Array(bins).fill(0);
                            
                            // 각 수익률을 적절한 빈에 할당
                            returns.forEach(ret => {
                                const binIndex = Math.min(bins - 1, Math.max(0, Math.floor((ret - globalMin) / binWidth)));
                                histogram[binIndex]++;
                            });
                            
                            // 데이터셋 추가
                            datasets.push({
                                label: indicatorColors[symbol].name,
                                data: histogram,
                                backgroundColor: indicatorColors[symbol].color + '80', // 알파값 추가
                                borderColor: indicatorColors[symbol].color,
                                borderWidth: 1,
                                barPercentage: 1,
                                categoryPercentage: 1,
                                parsing: false, // 성능 최적화
                                normalized: true // 성능 최적화
                            });
                        });
                        
                        // 빈 레이블 생성
                        const labels = Array(bins).fill('').map((_, i) => {
                            const binStart = globalMin + i * binWidth;
                            return binStart.toFixed(2) + '%';
                        });
                        
                        // Chart.js 성능 최적화 옵션
                        chartInstances.returnsDistribution = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                animation: false, // 애니메이션 비활성화 (성능 향상)
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: '일별 수익률 (%)'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: '빈도수'
                                        },
                                        beginAtZero: true
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '일별 수익률 분포',
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            title: function(tooltipItems) {
                                                const item = tooltipItems[0];
                                                const binStart = parseFloat(item.label);
                                                const binEnd = binStart + binWidth;
                                                return `수익률: ${binStart.toFixed(2)}% ~ ${binEnd.toFixed(2)}%`;
                                            },
                                            label: function(context) {
                                                return `${context.dataset.label}: ${context.parsed.y}회`;
                                            }
                                        }
                                    },
                                    legend: {
                                        position: 'top',
                                        labels: {
                                            boxWidth: 12,
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {</script><div class="ap-ext ap-ext-taobao_search_by_image"><div translate="no" class="ap-base ap-base--ltr ap-theme--dark"><div><div class="ap-toolbar ap-toolbar--left ap-toolbar--collapse"><!----><div class="ap-toolbar__inner"><!----><!----><!----></div></div></div><!----><div><!----><div class="ap-sbi"><div class="ap-sbi-btn-search-wrapper" style="cursor: pointer; display: none;"><div class="ap-sbi-btn-search"><i class="ap-sbi-btn-search__icon ap-icon-search"></i><span class="ap-sbi-btn-search__txt">AliPrice</span></div><div class="ap-sbi-options"><div class="ap-sbi-options__label"><i class="ap-sbi-options__icon ap-icon-vertical-ellipsis"></i></div><!----></div></div><!----><div class="ap-sbi-aside"><!----><div class="ap-sbi-aside-btn-minimize" style="display: none;"><img src="https://page.genspark.site/page/toolu_01Ht3TwPuiQrpkhDArXsAzv4/us_market_analyzer_optimized.html" class="ap-sbi-img-thumb"><i class="ap-sbi-aside-btn-minimize__icon ap-icon-chevron-right"></i></div><!----></div><!----></div></div><!----><!----><div></div><div></div><div></div><div></div><!----><div></div><div><!----></div><div></div><div></div><!----><!----><!----><div></div><div></div><div><!----></div><div></div><div class="ap-sub-favorite-modal" config="[object Object]"><!----></div><!----><!----></div></div></body></html>